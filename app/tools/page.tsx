"use client";
import { useEffect, useMemo, useState } from 'react';

type Persona = {
  name: string;
  role: string;
  mainGoal: string;
  pains: string;
  channels: string;
  budget: string;
};

function useLocalStorage<T>(key: string, initial: T) {
  const [value, setValue] = useState<T>(() => {
    if (typeof window === 'undefined') return initial;
    const raw = window.localStorage.getItem(key);
    return raw ? (JSON.parse(raw) as T) : initial;
  });
  useEffect(() => {
    if (typeof window === 'undefined') return;
    window.localStorage.setItem(key, JSON.stringify(value));
  }, [key, value]);
  return [value, setValue] as const;
}

export default function ToolsPage() {
  return (
    <div className="grid" style={{gap:16}}>
      <section className="card">
        <h1 className="h1">????? ???????</h1>
        <p className="p">???? ????? ????? ???????? ??? ?????? ??????? ???? ??????? ?????? ???? ??? MVP ????? ???????.</p>
      </section>
      <div className="grid grid-3">
        <PersonaBuilder />
        <NicheScorer />
        <MVPPlanner />
      </div>
    </div>
  );
}

function PersonaBuilder() {
  const [persona, setPersona] = useLocalStorage<Persona>('persona', {
    name: '', role: '', mainGoal: '', pains: '', channels: '', budget: '?????'
  });

  const summary = useMemo(() => {
    if (!persona.role && !persona.mainGoal) return '';
    return `\n? ?????: ${persona.name || '??? ????'}\n? ?????: ${persona.role}\n? ?????: ${persona.mainGoal}\n? ??????: ${persona.pains}\n? ???????: ${persona.channels}\n? ?????????: ${persona.budget}`;
  }, [persona]);

  return (
    <div className="card">
      <h2 className="h2">???? ?????????</h2>
      <label className="label">?????</label>
      <input className="input" value={persona.name} onChange={e=>setPersona({...persona, name:e.target.value})} placeholder="????: ????" />
      <label className="label">?????/?????</label>
      <input className="input" value={persona.role} onChange={e=>setPersona({...persona, role:e.target.value})} placeholder="????: ???? ?????? ?????? ???? ?????" />
      <label className="label">????? ???????</label>
      <input className="input" value={persona.mainGoal} onChange={e=>setPersona({...persona, mainGoal:e.target.value})} placeholder="????: ????? ????? ??? ???? ????" />
      <label className="label">??????/????????</label>
      <textarea className="textarea" value={persona.pains} onChange={e=>setPersona({...persona, pains:e.target.value})} placeholder="??? ?????? ????? ???????? ??? ???? ???????" />
      <label className="label">????? ???????</label>
      <input className="input" value={persona.channels} onChange={e=>setPersona({...persona, channels:e.target.value})} placeholder="X, LinkedIn, Reddit, ??????? ??????" />
      <label className="label">?????????</label>
      <select className="select" value={persona.budget} onChange={e=>setPersona({...persona, budget:e.target.value})}>
        <option>?????</option>
        <option>?????</option>
        <option>?????</option>
      </select>
      <div style={{marginTop:10}}>
        <button className="button" onClick={()=>navigator.clipboard.writeText(summary)}>??? ??????</button>
      </div>
      {summary && (
        <pre style={{whiteSpace:'pre-wrap',marginTop:12}} className="small">{summary}</pre>
      )}
    </div>
  );
}

function NicheScorer() {
  const [inputs, setInputs] = useLocalStorage('niche-score-inputs', {
    demand: 3, competition: 3, monetization: 3, urgency: 3, retention: 3
  });

  const score = useMemo(() => {
    const { demand, competition, monetization, urgency, retention } = inputs as any;
    const compInverted = 6 - competition; // ????? ?????? = ???? ????
    const total = demand*0.3 + compInverted*0.2 + monetization*0.25 + urgency*0.15 + retention*0.1;
    return Math.round(total / 5 * 100);
  }, [inputs]);

  const rating = score >= 80 ? '?????' : score >= 65 ? '???' : score >= 50 ? '???? ????????' : '????';

  function Slider({label, keyName}:{label:string; keyName:keyof typeof inputs}){
    return (
      <div>
        <label className="label">{label}: <b>{(inputs as any)[keyName]}</b></label>
        <input type="range" min={1} max={5} value={(inputs as any)[keyName]} onChange={e=>setInputs({...inputs,[keyName]:Number(e.target.value)})} />
      </div>
    );
  }

  return (
    <div className="card">
      <h2 className="h2">????? ?????? (0-100)</h2>
      <Slider label="?????" keyName="demand" />
      <Slider label="???????? (??? ????)" keyName="competition" />
      <Slider label="?????? ?????" keyName="monetization" />
      <Slider label="?????????" keyName="urgency" />
      <Slider label="????????/????? ??????" keyName="retention" />
      <div style={{marginTop:12}}>
        <div className="kpi"><span className="num">{score}</span><span>? {rating}</span></div>
        <p className="small">???? ????? ????????. ??? ???? ??????? ? 65 ????? MVP ??????.</p>
      </div>
    </div>
  );
}

function MVPPlanner() {
  const [steps, setSteps] = useLocalStorage('mvp-steps', [
    { text: '????? ????? ????? ????? ????????', done: false },
    { text: '??? ?????? ?????????? ????????', done: false },
    { text: '????? ????? ???? ????? ??? 5 ?????', done: false },
    { text: '????? ????? ??? ?????????', done: false },
    { text: '????? ???? ?????? ??????', done: false },
  ] as {text:string; done:boolean;}[]);

  function toggle(i:number){
    const next = steps.slice();
    next[i] = { ...next[i], done: !next[i].done };
    setSteps(next);
  }

  return (
    <div className="card">
      <h2 className="h2">???? ????? MVP</h2>
      <div className="checklist">
        {steps.map((s, i) => (
          <label key={i} className="checklist-item">
            <input type="checkbox" checked={s.done} onChange={()=>toggle(i)} />
            <span>{s.text}</span>
          </label>
        ))}
      </div>
      <div style={{display:'flex',gap:8,marginTop:12}}>
        <button className="button" onClick={()=>setSteps(steps.map(s=>({...s,done:false})))}>????? ?????</button>
        <button className="button" onClick={()=>navigator.clipboard.writeText(steps.map(s=>`- [${s.done?'x':' '}] ${s.text}`).join('\n'))}>??? ?????? ????</button>
      </div>
    </div>
  );
}
